<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE RecordWildCards #-}
<span class="lineno">    2 </span>{-# LANGUAGE ViewPatterns #-}
<span class="lineno">    3 </span>
<span class="lineno">    4 </span>module Conjure.UI.MainHelper ( mainWithArgs, savilerowScriptName ) where
<span class="lineno">    5 </span>
<span class="lineno">    6 </span>import Conjure.Prelude
<span class="lineno">    7 </span>import Conjure.Bug
<span class="lineno">    8 </span>import Conjure.UserError
<span class="lineno">    9 </span>import Conjure.UI ( UI(..), OutputFormat(..) )
<span class="lineno">   10 </span>import Conjure.UI.IO ( readModel, readModelFromFile, readModelFromStdin
<span class="lineno">   11 </span>                     , readModelInfoFromFile, readParamOrSolutionFromFile
<span class="lineno">   12 </span>                     , writeModel )
<span class="lineno">   13 </span>import Conjure.UI.Model ( parseStrategy, outputModels, modelRepresentationsJSON )
<span class="lineno">   14 </span>import qualified Conjure.UI.Model as Config ( Config(..) )
<span class="lineno">   15 </span>import Conjure.UI.TranslateParameter ( translateParameter )
<span class="lineno">   16 </span>import Conjure.UI.TranslateSolution ( translateSolution )
<span class="lineno">   17 </span>import Conjure.UI.ValidateSolution ( validateSolution )
<span class="lineno">   18 </span>import Conjure.UI.TypeCheck ( typeCheckModel_StandAlone )
<span class="lineno">   19 </span>import Conjure.UI.Split ( outputSplittedModels, removeUnusedDecls )
<span class="lineno">   20 </span>import Conjure.UI.VarSymBreaking ( outputVarSymBreaking )
<span class="lineno">   21 </span>import Conjure.UI.ParameterGenerator ( parameterGenerator )
<span class="lineno">   22 </span>import Conjure.UI.NormaliseQuantified ( normaliseQuantifiedVariables )
<span class="lineno">   23 </span>import Conjure.UI.TypeScript ( tsDef )
<span class="lineno">   24 </span>
<span class="lineno">   25 </span>import Conjure.Language.Name ( Name(..) )
<span class="lineno">   26 </span>import Conjure.Language.Definition ( Model(..), Statement(..), Declaration(..), FindOrGiven(..) )
<span class="lineno">   27 </span>import Conjure.Language.Type ( TypeCheckerMode(..) )
<span class="lineno">   28 </span>import Conjure.Language.Domain ( Domain(..), Range(..) )
<span class="lineno">   29 </span>import Conjure.Language.NameGen ( NameGenM, runNameGen )
<span class="lineno">   30 </span>import Conjure.Language.Pretty ( pretty, prettyList, renderNormal, render, prParens )
<span class="lineno">   31 </span>import qualified Conjure.Language.ParserC as ParserC ( parseModel )
<span class="lineno">   32 </span>import Conjure.Language.ModelDiff ( modelDiffIO )
<span class="lineno">   33 </span>import Conjure.Rules.Definition ( viewAuto, Strategy(..) )
<span class="lineno">   34 </span>import Conjure.Process.Enumerate ( EnumerateDomain )
<span class="lineno">   35 </span>import Conjure.Process.ModelStrengthening ( strengthenModel )
<span class="lineno">   36 </span>import Conjure.Language.NameResolution ( resolveNamesMulti )
<span class="lineno">   37 </span>import Conjure.Language.ModelStats ( modelDeclarationsJSON )
<span class="lineno">   38 </span>
<span class="lineno">   39 </span>-- base
<span class="lineno">   40 </span>import System.IO ( Handle, hSetBuffering, stdout, BufferMode(..) )
<span class="lineno">   41 </span>import System.Environment ( getEnvironment )
<span class="lineno">   42 </span>import System.Info ( os )
<span class="lineno">   43 </span>import GHC.Conc ( numCapabilities )
<span class="lineno">   44 </span>import GHC.IO.Handle ( hIsEOF, hClose, hGetLine )
<span class="lineno">   45 </span>import Data.Char ( isDigit )
<span class="lineno">   46 </span>
<span class="lineno">   47 </span>-- containers
<span class="lineno">   48 </span>import qualified Data.Set as S
<span class="lineno">   49 </span>
<span class="lineno">   50 </span>-- filepath
<span class="lineno">   51 </span>import System.FilePath ( splitFileName, takeBaseName, (&lt;.&gt;) )
<span class="lineno">   52 </span>
<span class="lineno">   53 </span>-- system-filepath
<span class="lineno">   54 </span>import qualified Filesystem.Path as Sys ( FilePath )
<span class="lineno">   55 </span>
<span class="lineno">   56 </span>-- directory
<span class="lineno">   57 </span>import System.Directory ( copyFile, findExecutable )
<span class="lineno">   58 </span>
<span class="lineno">   59 </span>-- shelly
<span class="lineno">   60 </span>import Shelly ( runHandle, lastStderr, lastExitCode, errExit, Sh )
<span class="lineno">   61 </span>
<span class="lineno">   62 </span>-- text
<span class="lineno">   63 </span>import qualified Data.Text as T ( unlines, isInfixOf )
<span class="lineno">   64 </span>
<span class="lineno">   65 </span>-- parallel-io
<span class="lineno">   66 </span>import Control.Concurrent.ParallelIO.Global ( parallel, parallel_, stopGlobalPool )
<span class="lineno">   67 </span>
<span class="lineno">   68 </span>
<span class="lineno">   69 </span>mainWithArgs :: forall m .
<span class="lineno">   70 </span>    MonadIO m =&gt;
<span class="lineno">   71 </span>    MonadLog m =&gt;
<span class="lineno">   72 </span>    MonadFail m =&gt;
<span class="lineno">   73 </span>    EnumerateDomain m =&gt;
<span class="lineno">   74 </span>    (?typeCheckerMode :: TypeCheckerMode) =&gt;
<span class="lineno">   75 </span>    UI -&gt; m ()
<span class="lineno">   76 </span><span class="decl"><span class="istickedoff">mainWithArgs TSDEF{} = <span class="nottickedoff">liftIO tsDef</span></span>
<span class="lineno">   77 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs mode@Modelling{..} = do</span>
<span class="lineno">   78 </span><span class="spaces">    </span><span class="istickedoff">essenceM &lt;- readModelFromFile essence</span>
<span class="lineno">   79 </span><span class="spaces">    </span><span class="istickedoff">doIfNotCached          -- start the show!</span>
<span class="lineno">   80 </span><span class="spaces">        </span><span class="istickedoff">( sort (mStatements essenceM)</span>
<span class="lineno">   81 </span><span class="spaces">        </span><span class="istickedoff">, portfolio</span>
<span class="lineno">   82 </span><span class="spaces">        </span><span class="istickedoff">-- when the following flags change, invalidate hash</span>
<span class="lineno">   83 </span><span class="spaces">        </span><span class="istickedoff">-- nested tuples, because :(</span>
<span class="lineno">   84 </span><span class="spaces">        </span><span class="istickedoff">, ( numberingStart</span>
<span class="lineno">   85 </span><span class="spaces">          </span><span class="istickedoff">, smartFilenames</span>
<span class="lineno">   86 </span><span class="spaces">          </span><span class="istickedoff">, strategyQ</span>
<span class="lineno">   87 </span><span class="spaces">          </span><span class="istickedoff">, strategyA</span>
<span class="lineno">   88 </span><span class="spaces">          </span><span class="istickedoff">, responses</span>
<span class="lineno">   89 </span><span class="spaces">          </span><span class="istickedoff">)</span>
<span class="lineno">   90 </span><span class="spaces">        </span><span class="istickedoff">, ( representations</span>
<span class="lineno">   91 </span><span class="spaces">          </span><span class="istickedoff">, representationsFinds</span>
<span class="lineno">   92 </span><span class="spaces">          </span><span class="istickedoff">, representationsGivens</span>
<span class="lineno">   93 </span><span class="spaces">          </span><span class="istickedoff">, representationsAuxiliaries</span>
<span class="lineno">   94 </span><span class="spaces">          </span><span class="istickedoff">, representationsQuantifieds</span>
<span class="lineno">   95 </span><span class="spaces">          </span><span class="istickedoff">, representationsCuts</span>
<span class="lineno">   96 </span><span class="spaces">          </span><span class="istickedoff">)</span>
<span class="lineno">   97 </span><span class="spaces">        </span><span class="istickedoff">, ( channelling</span>
<span class="lineno">   98 </span><span class="spaces">          </span><span class="istickedoff">, representationLevels</span>
<span class="lineno">   99 </span><span class="spaces">          </span><span class="istickedoff">, seed</span>
<span class="lineno">  100 </span><span class="spaces">          </span><span class="istickedoff">, limitModels</span>
<span class="lineno">  101 </span><span class="spaces">          </span><span class="istickedoff">, limitTime</span>
<span class="lineno">  102 </span><span class="spaces">          </span><span class="istickedoff">, outputFormat</span>
<span class="lineno">  103 </span><span class="spaces">          </span><span class="istickedoff">)</span>
<span class="lineno">  104 </span><span class="spaces">        </span><span class="istickedoff">)</span>
<span class="lineno">  105 </span><span class="spaces">        </span><span class="istickedoff">(outputDirectory &lt;/&gt; &quot;.conjure-checksum&quot;)</span>
<span class="lineno">  106 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">(pp logLevel &quot;Using cached models.&quot;)</span></span>
<span class="lineno">  107 </span><span class="spaces">        </span><span class="istickedoff">(void $ mainWithArgs_Modelling &quot;&quot; mode Nothing S.empty)</span>
<span class="lineno">  108 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs TranslateParameter{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  109 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">when (null eprime      ) $ userErr1 &quot;Mandatory field --eprime&quot;</span></span>
<span class="lineno">  110 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">when (null essenceParam) $ userErr1 &quot;Mandatory field --essence-param&quot;</span></span>
<span class="lineno">  111 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">let outputFilename = fromMaybe (dropExtension essenceParam ++ &quot;.eprime-param&quot;) eprimeParam</span></span>
<span class="lineno">  112 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">eprimeF &lt;- readModelInfoFromFile eprime</span></span>
<span class="lineno">  113 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">essenceParamF &lt;- readParamOrSolutionFromFile essenceParam</span></span>
<span class="lineno">  114 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">output &lt;- runNameGen () $ translateParameter False eprimeF essenceParamF</span></span>
<span class="lineno">  115 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">writeModel lineWidth outputFormat (Just outputFilename) output</span></span>
<span class="lineno">  116 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs TranslateSolution{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  117 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">when (null eprime        ) $ userErr1 &quot;Mandatory field --eprime&quot;</span></span>
<span class="lineno">  118 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">when (null eprimeSolution) $ userErr1 &quot;Mandatory field --eprime-solution&quot;</span></span>
<span class="lineno">  119 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">eprimeF &lt;- readModelInfoFromFile eprime</span></span>
<span class="lineno">  120 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">essenceParamF &lt;- maybe (return def) readParamOrSolutionFromFile essenceParamO</span></span>
<span class="lineno">  121 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">eprimeSolutionF &lt;- readParamOrSolutionFromFile eprimeSolution</span></span>
<span class="lineno">  122 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">output &lt;- runNameGen () $ translateSolution eprimeF essenceParamF eprimeSolutionF</span></span>
<span class="lineno">  123 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">let outputFilename = fromMaybe (dropExtension eprimeSolution ++ &quot;.solution&quot;) essenceSolutionO</span></span>
<span class="lineno">  124 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">writeModel lineWidth outputFormat (Just outputFilename) output</span></span>
<span class="lineno">  125 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs ValidateSolution{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  126 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">when (null essence        ) $ userErr1 &quot;Mandatory field --essence&quot;</span></span>
<span class="lineno">  127 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">when (null essenceSolution) $ userErr1 &quot;Mandatory field --solution&quot;</span></span>
<span class="lineno">  128 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">essence2  &lt;- readModelFromFile essence</span></span>
<span class="lineno">  129 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">param2    &lt;- maybe (return def) readParamOrSolutionFromFile essenceParamO</span></span>
<span class="lineno">  130 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">solution2 &lt;- readParamOrSolutionFromFile essenceSolution</span></span>
<span class="lineno">  131 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">[essence3, param3, solution3] &lt;- runNameGen () $ resolveNamesMulti [essence2, param2, solution2]</span></span>
<span class="lineno">  132 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">runNameGen () $ validateSolution essence3 param3 solution3</span></span>
<span class="lineno">  133 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs IDE{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  134 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">essence2 &lt;-</span></span>
<span class="lineno">  135 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">if null essence</span></span>
<span class="lineno">  136 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">then readModelFromStdin</span></span>
<span class="lineno">  137 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">else readModelFromFile essence</span></span>
<span class="lineno">  138 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">void $ runNameGen () $ typeCheckModel_StandAlone essence2</span></span>
<span class="lineno">  139 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">if</span></span>
<span class="lineno">  140 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">| dumpDeclarations    -&gt; liftIO $ putStrLn $ render lineWidth (modelDeclarationsJSON essence2)</span></span>
<span class="lineno">  141 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">| dumpRepresentations -&gt; do</span></span>
<span class="lineno">  142 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">json &lt;- runNameGen () $ modelRepresentationsJSON essence2</span></span>
<span class="lineno">  143 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">liftIO $ putStrLn $ render lineWidth json</span></span>
<span class="lineno">  144 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">| otherwise           -&gt; writeModel lineWidth ASTJSON Nothing essence2</span></span>
<span class="lineno">  145 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs Pretty{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  146 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">model0 &lt;- if or [ s `isSuffixOf` essence</span></span>
<span class="lineno">  147 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">| s &lt;- [&quot;.param&quot;, &quot;.eprime-param&quot;, &quot;.solution&quot;, &quot;.eprime.solution&quot;] ]</span></span>
<span class="lineno">  148 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">then do</span></span>
<span class="lineno">  149 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">liftIO $ putStrLn &quot;Parsing as a parameter file&quot;</span></span>
<span class="lineno">  150 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">readParamOrSolutionFromFile essence</span></span>
<span class="lineno">  151 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">else readModelFromFile essence</span></span>
<span class="lineno">  152 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">let model1 = model0</span></span>
<span class="lineno">  153 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">|&gt; (if normaliseQuantified then normaliseQuantifiedVariables else id)</span></span>
<span class="lineno">  154 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">|&gt; (if removeUnused then removeUnusedDecls else id)</span></span>
<span class="lineno">  155 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">writeModel lineWidth outputFormat Nothing model1</span></span>
<span class="lineno">  156 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs Diff{..} =</span>
<span class="lineno">  157 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">join $ modelDiffIO</span></span>
<span class="lineno">  158 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">&lt;$&gt; readModelFromFile file1</span></span>
<span class="lineno">  159 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">&lt;*&gt; readModelFromFile file2</span></span>
<span class="lineno">  160 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs TypeCheck{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  161 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">essenceF &lt;- readModelFromFile essence</span></span>
<span class="lineno">  162 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">void $ runNameGen () $ typeCheckModel_StandAlone essenceF</span></span>
<span class="lineno">  163 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs Split{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  164 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">model &lt;- readModelFromFile essence</span></span>
<span class="lineno">  165 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">outputSplittedModels outputDirectory model</span></span>
<span class="lineno">  166 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs SymmetryDetection{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  167 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">let jsonFilePath = if null json then essence ++ &quot;-json&quot; else json</span></span>
<span class="lineno">  168 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">model &lt;- readModelFromFile essence</span></span>
<span class="lineno">  169 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">outputVarSymBreaking jsonFilePath model</span></span>
<span class="lineno">  170 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs ParameterGenerator{..} = <span class="nottickedoff">do</span></span>
<span class="lineno">  171 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">when (null essenceOut) $ userErr1 &quot;Mandatory field --essence-out&quot;</span></span>
<span class="lineno">  172 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">model &lt;- readModelFromFile essence</span></span>
<span class="lineno">  173 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">(output, classes) &lt;- runNameGen () $ parameterGenerator minInt maxInt model</span></span>
<span class="lineno">  174 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">writeModel lineWidth outputFormat (Just essenceOut) output</span></span>
<span class="lineno">  175 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">let</span></span>
<span class="lineno">  176 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">toIrace nm lb ub _ | lb == ub =</span></span>
<span class="lineno">  177 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">pretty nm &lt;+&gt;</span></span>
<span class="lineno">  178 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">&quot;\&quot;-&quot; &lt;&gt; pretty nm &lt;&gt; &quot; \&quot; c&quot; &lt;+&gt;</span></span>
<span class="lineno">  179 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">prParens (pretty lb)</span></span>
<span class="lineno">  180 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">toIrace nm lb ub (Just klass) =</span></span>
<span class="lineno">  181 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">pretty nm &lt;+&gt;</span></span>
<span class="lineno">  182 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">&quot;\&quot;-&quot; &lt;&gt; pretty nm &lt;&gt; &quot; \&quot; &quot; &lt;&gt; pretty klass &lt;+&gt;</span></span>
<span class="lineno">  183 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">prettyList prParens &quot;,&quot; [lb, ub]</span></span>
<span class="lineno">  184 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">toIrace nm _ _ Nothing = bug (&quot;Missing class for:&quot; &lt;+&gt; pretty nm)</span></span>
<span class="lineno">  185 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"></span></span>
<span class="lineno">  186 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">essenceOutFileContents = render lineWidth $ vcat</span></span>
<span class="lineno">  187 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">[ toIrace nm lb ub (lookup nm classes)</span></span>
<span class="lineno">  188 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">| Declaration (FindOrGiven Given nm (DomainInt _ [RangeBounded lb ub])) &lt;- mStatements output</span></span>
<span class="lineno">  189 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  190 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">liftIO $ writeFile (essenceOut ++ &quot;.irace&quot;) (essenceOutFileContents ++ &quot;\n&quot;)</span></span>
<span class="lineno">  191 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs ModelStrengthening{..} =</span>
<span class="lineno">  192 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">readModelFromFile essence &gt;&gt;=</span></span>
<span class="lineno">  193 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">strengthenModel logLevel logRuleSuccesses &gt;&gt;=</span></span>
<span class="lineno">  194 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">writeModel lineWidth outputFormat (Just essenceOut)</span></span>
<span class="lineno">  195 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs config@Solve{..} = do</span>
<span class="lineno">  196 </span><span class="spaces">    </span><span class="istickedoff">let executables = [ ( &quot;minion&quot;          , &quot;minion&quot; )</span>
<span class="lineno">  197 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;gecode&quot;          , &quot;fzn-gecode&quot; )</span></span>
<span class="lineno">  198 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;chuffed&quot;         , &quot;fzn-chuffed&quot; )</span></span>
<span class="lineno">  199 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;cadical&quot;         , &quot;cadical&quot; )</span></span>
<span class="lineno">  200 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;glucose&quot;         , &quot;glucose&quot; )</span></span>
<span class="lineno">  201 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;glucose-syrup&quot;   , &quot;glucose-syrup&quot; )</span></span>
<span class="lineno">  202 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;lingeling&quot;       , &quot;lingeling&quot; )</span></span>
<span class="lineno">  203 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;plingeling&quot;      , &quot;plingeling&quot; )</span></span>
<span class="lineno">  204 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;treengeling&quot;     , &quot;treengeling&quot; )</span></span>
<span class="lineno">  205 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;minisat&quot;         , &quot;minisat&quot; )</span></span>
<span class="lineno">  206 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;bc_minisat_all&quot;  , &quot;bc_minisat_all_release&quot; )</span></span>
<span class="lineno">  207 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;nbc_minisat_all&quot; , &quot;nbc_minisat_all_release&quot; )</span></span>
<span class="lineno">  208 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;open-wbo&quot;        , &quot;open-wbo&quot; )</span></span>
<span class="lineno">  209 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;coin-or&quot;         , &quot;minizinc&quot; )</span></span>
<span class="lineno">  210 </span><span class="spaces">                      </span><span class="istickedoff">, <span class="nottickedoff">( &quot;cplex&quot;           , &quot;minizinc&quot; )</span></span>
<span class="lineno">  211 </span><span class="spaces">                      </span><span class="istickedoff">]</span>
<span class="lineno">  212 </span><span class="spaces">    </span><span class="istickedoff">-- some sanity checks</span>
<span class="lineno">  213 </span><span class="spaces">    </span><span class="istickedoff">case lookup solver executables of</span>
<span class="lineno">  214 </span><span class="spaces">        </span><span class="istickedoff">Nothing -&gt; <span class="nottickedoff">userErr1 (&quot;Unsupported solver:&quot; &lt;+&gt; pretty solver)</span></span>
<span class="lineno">  215 </span><span class="spaces">        </span><span class="istickedoff">Just ex -&gt; do</span>
<span class="lineno">  216 </span><span class="spaces">            </span><span class="istickedoff">fp &lt;- liftIO $ findExecutable ex</span>
<span class="lineno">  217 </span><span class="spaces">            </span><span class="istickedoff">case fp of</span>
<span class="lineno">  218 </span><span class="spaces">                </span><span class="istickedoff">Nothing -&gt; <span class="nottickedoff">userErr1 (&quot;Cannot find executable&quot; &lt;+&gt; pretty ex &lt;+&gt; &quot;(for solver&quot; &lt;+&gt; pretty solver &lt;&gt; &quot;)&quot;)</span></span>
<span class="lineno">  219 </span><span class="spaces">                </span><span class="istickedoff">Just _  -&gt; return <span class="nottickedoff">()</span></span>
<span class="lineno">  220 </span><span class="spaces">    </span><span class="istickedoff">case solver of</span>
<span class="lineno">  221 </span><span class="spaces">        </span><span class="istickedoff">&quot;cplex&quot; -&gt; <span class="nottickedoff">do</span></span>
<span class="lineno">  222 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">env &lt;- liftIO getEnvironment</span></span>
<span class="lineno">  223 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">case lookup &quot;CPLEX_PATH&quot; env of</span></span>
<span class="lineno">  224 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">Nothing -&gt; userErr1 $ vcat</span></span>
<span class="lineno">  225 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">[ &quot;Set environment variable CPLEX_PATH. Something like:&quot;</span></span>
<span class="lineno">  226 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">, &quot;    CPLEX_PATH=/path/to/cplex/library conjure solve&quot;</span></span>
<span class="lineno">  227 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  228 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">Just{} -&gt; return ()</span></span>
<span class="lineno">  229 </span><span class="spaces">        </span><span class="istickedoff">_ -&gt; return <span class="nottickedoff">()</span></span>
<span class="lineno">  230 </span><span class="spaces">    </span><span class="istickedoff">unless (nbSolutions == &quot;all&quot; || all isDigit nbSolutions) $</span>
<span class="lineno">  231 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">userErr1 (vcat [ &quot;The value for --number-of-solutions must either be a number or the string \&quot;all\&quot;.&quot;</span></span>
<span class="lineno">  232 </span><span class="spaces">                       </span><span class="istickedoff"><span class="nottickedoff">, &quot;Was given:&quot; &lt;+&gt; pretty nbSolutions</span></span>
<span class="lineno">  233 </span><span class="spaces">                       </span><span class="istickedoff"><span class="nottickedoff">])</span></span>
<span class="lineno">  234 </span><span class="spaces">    </span><span class="istickedoff">when (solver `elem` [&quot;bc_minisat_all&quot;, &quot;nbc_minisat_all&quot;] &amp;&amp; <span class="nottickedoff">nbSolutions /= &quot;all&quot;</span>) $</span>
<span class="lineno">  235 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">userErr1 $ &quot;The solvers bc_minisat_all and nbc_minisat_all only work with --number-of-solutions=all&quot;</span></span>
<span class="lineno">  236 </span><span class="spaces">    </span><span class="istickedoff">essenceM &lt;- readModelFromFile essence</span>
<span class="lineno">  237 </span><span class="spaces">    </span><span class="istickedoff">unless (null [ <span class="nottickedoff">()</span> | Objective{} &lt;- mStatements essenceM ]) $ <span class="nottickedoff">do -- this is an optimisation problem</span></span>
<span class="lineno">  238 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">when (nbSolutions == &quot;all&quot; || nbSolutions /= &quot;1&quot;) $</span></span>
<span class="lineno">  239 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">userErr1 (&quot;Not supported for optimisation problems: --number-of-solutions=&quot; &lt;&gt; pretty nbSolutions)</span></span>
<span class="lineno">  240 </span><span class="spaces">    </span><span class="istickedoff">essenceParamsParsed &lt;- forM essenceParams $ <span class="nottickedoff">\ f -&gt; do</span></span>
<span class="lineno">  241 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">p &lt;- readParamOrSolutionFromFile f</span></span>
<span class="lineno">  242 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">return (f, p)</span></span>
<span class="lineno">  243 </span><span class="spaces">    </span><span class="istickedoff">let givens = [ <span class="nottickedoff">nm</span> | Declaration (FindOrGiven Given nm _) &lt;- mStatements essenceM ]</span>
<span class="lineno">  244 </span><span class="spaces">              </span><span class="istickedoff">++ [ <span class="nottickedoff">nm</span> | Declaration (GivenDomainDefnEnum nm) &lt;- mStatements essenceM ]</span>
<span class="lineno">  245 </span><span class="spaces">    </span><span class="istickedoff">when (not (null givens) &amp;&amp; <span class="nottickedoff">null essenceParams</span>) $</span>
<span class="lineno">  246 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">userErr1 $ vcat</span></span>
<span class="lineno">  247 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">[ &quot;The problem specification is parameterised, but no *.param files are given.&quot;</span></span>
<span class="lineno">  248 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">, &quot;Parameters:&quot; &lt;+&gt; prettyList id &quot;,&quot; givens</span></span>
<span class="lineno">  249 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  250 </span><span class="spaces">    </span><span class="istickedoff">let <span class="nottickedoff">isEmptyParam Model{mStatements=[]} = True</span></span>
<span class="lineno">  251 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">isEmptyParam _ = False</span></span>
<span class="lineno">  252 </span><span class="spaces">        </span><span class="istickedoff">hasNonEmptyParams =</span>
<span class="lineno">  253 </span><span class="spaces">            </span><span class="istickedoff">null essenceParams ||                               -- either no params were given</span>
<span class="lineno">  254 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">all (isEmptyParam . snd) essenceParamsParsed</span>        -- or all those given were empty</span>
<span class="lineno">  255 </span><span class="spaces">    </span><span class="istickedoff">when (null givens &amp;&amp; not hasNonEmptyParams) $</span>
<span class="lineno">  256 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">userErr1 &quot;The problem specification is _not_ parameterised, but *.param files are given.&quot;</span></span>
<span class="lineno">  257 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  258 </span><span class="spaces">    </span><span class="istickedoff">eprimes &lt;-</span>
<span class="lineno">  259 </span><span class="spaces">        </span><span class="istickedoff">if <span class="tickonlyfalse">not (null useExistingModels)</span></span>
<span class="lineno">  260 </span><span class="spaces">            </span><span class="istickedoff">then <span class="nottickedoff">do</span></span>
<span class="lineno">  261 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">pp logLevel &quot;Using existing models.&quot;</span></span>
<span class="lineno">  262 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">allEprimes &lt;- getEprimes</span></span>
<span class="lineno">  263 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">let missingModels = useExistingModels \\ allEprimes</span></span>
<span class="lineno">  264 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">if null missingModels</span></span>
<span class="lineno">  265 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">then return useExistingModels</span></span>
<span class="lineno">  266 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">else userErr1 $ &quot;Models not found:&quot; &lt;+&gt; vcat (map pretty missingModels)</span></span>
<span class="lineno">  267 </span><span class="spaces">            </span><span class="istickedoff">else doIfNotCached          -- start the show!</span>
<span class="lineno">  268 </span><span class="spaces">                    </span><span class="istickedoff">( sort (mStatements essenceM)</span>
<span class="lineno">  269 </span><span class="spaces">                    </span><span class="istickedoff">, portfolio</span>
<span class="lineno">  270 </span><span class="spaces">                    </span><span class="istickedoff">-- when the following flags change, invalidate hash</span>
<span class="lineno">  271 </span><span class="spaces">                    </span><span class="istickedoff">-- nested tuples, because :(</span>
<span class="lineno">  272 </span><span class="spaces">                    </span><span class="istickedoff">, ( numberingStart</span>
<span class="lineno">  273 </span><span class="spaces">                      </span><span class="istickedoff">, smartFilenames</span>
<span class="lineno">  274 </span><span class="spaces">                      </span><span class="istickedoff">, strategyQ</span>
<span class="lineno">  275 </span><span class="spaces">                      </span><span class="istickedoff">, strategyA</span>
<span class="lineno">  276 </span><span class="spaces">                      </span><span class="istickedoff">, responses</span>
<span class="lineno">  277 </span><span class="spaces">                      </span><span class="istickedoff">)</span>
<span class="lineno">  278 </span><span class="spaces">                    </span><span class="istickedoff">, ( representations</span>
<span class="lineno">  279 </span><span class="spaces">                      </span><span class="istickedoff">, representationsFinds</span>
<span class="lineno">  280 </span><span class="spaces">                      </span><span class="istickedoff">, representationsGivens</span>
<span class="lineno">  281 </span><span class="spaces">                      </span><span class="istickedoff">, representationsAuxiliaries</span>
<span class="lineno">  282 </span><span class="spaces">                      </span><span class="istickedoff">, representationsQuantifieds</span>
<span class="lineno">  283 </span><span class="spaces">                      </span><span class="istickedoff">, representationsCuts</span>
<span class="lineno">  284 </span><span class="spaces">                      </span><span class="istickedoff">)</span>
<span class="lineno">  285 </span><span class="spaces">                    </span><span class="istickedoff">, ( channelling</span>
<span class="lineno">  286 </span><span class="spaces">                      </span><span class="istickedoff">, representationLevels</span>
<span class="lineno">  287 </span><span class="spaces">                      </span><span class="istickedoff">, seed</span>
<span class="lineno">  288 </span><span class="spaces">                      </span><span class="istickedoff">, limitModels</span>
<span class="lineno">  289 </span><span class="spaces">                      </span><span class="istickedoff">, limitTime</span>
<span class="lineno">  290 </span><span class="spaces">                      </span><span class="istickedoff">, outputFormat</span>
<span class="lineno">  291 </span><span class="spaces">                      </span><span class="istickedoff">)</span>
<span class="lineno">  292 </span><span class="spaces">                    </span><span class="istickedoff">)</span>
<span class="lineno">  293 </span><span class="spaces">                    </span><span class="istickedoff">(outputDirectory &lt;/&gt; &quot;.conjure-checksum&quot;)</span>
<span class="lineno">  294 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">(pp logLevel &quot;Using cached models.&quot; &gt;&gt; getEprimes)</span></span>
<span class="lineno">  295 </span><span class="spaces">                    </span><span class="istickedoff">conjuring</span>
<span class="lineno">  296 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  297 </span><span class="spaces">    </span><span class="istickedoff">eprimesParsed &lt;- forM eprimes $ \ f -&gt; do</span>
<span class="lineno">  298 </span><span class="spaces">        </span><span class="istickedoff">p &lt;- readModelInfoFromFile (outputDirectory &lt;/&gt; f)</span>
<span class="lineno">  299 </span><span class="spaces">        </span><span class="istickedoff">return (f, p)</span>
<span class="lineno">  300 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  301 </span><span class="spaces">    </span><span class="istickedoff">msolutions &lt;- liftIO $ savileRows eprimesParsed essenceParamsParsed</span>
<span class="lineno">  302 </span><span class="spaces">    </span><span class="istickedoff">case msolutions of</span>
<span class="lineno">  303 </span><span class="spaces">        </span><span class="istickedoff">Left msg        -&gt; <span class="nottickedoff">userErr msg</span></span>
<span class="lineno">  304 </span><span class="spaces">        </span><span class="istickedoff">Right []        -&gt; pp logLevel <span class="nottickedoff">&quot;No solutions found.&quot;</span></span>
<span class="lineno">  305 </span><span class="spaces">        </span><span class="istickedoff">Right solutions -&gt; do</span>
<span class="lineno">  306 </span><span class="spaces">            </span><span class="istickedoff">when validateSolutionsOpt $ <span class="nottickedoff">liftIO $ validating solutions</span></span>
<span class="lineno">  307 </span><span class="spaces">            </span><span class="istickedoff">when copySolutions $ <span class="nottickedoff">do</span></span>
<span class="lineno">  308 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">-- clean-up: move the solutions next to the essence file.</span></span>
<span class="lineno">  309 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">-- our intention is that a user intending to just solve something</span></span>
<span class="lineno">  310 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">-- should never have to look into outputDirectory.</span></span>
<span class="lineno">  311 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">let</span></span>
<span class="lineno">  312 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">copySolution :: MonadIO m =&gt; FilePath -&gt; FilePath -&gt; m ()</span></span>
<span class="lineno">  313 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">copySolution old new = do</span></span>
<span class="lineno">  314 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">pp logLevel (&quot;Copying solution to:&quot; &lt;+&gt; pretty new)</span></span>
<span class="lineno">  315 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">liftIO (copyFile old new)</span></span>
<span class="lineno">  316 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">let (essenceDir0, essenceFilename) = splitFileName essence</span></span>
<span class="lineno">  317 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">let essenceDir = if essenceDir0 == &quot;./&quot; then &quot;&quot; else essenceDir0</span></span>
<span class="lineno">  318 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">let essenceBasename = takeBaseName essenceFilename</span></span>
<span class="lineno">  319 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">when (length eprimes == 1) $</span></span>
<span class="lineno">  320 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">if null essenceParams</span></span>
<span class="lineno">  321 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">then do</span></span>
<span class="lineno">  322 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let solutions' = [ solution</span></span>
<span class="lineno">  323 </span><span class="spaces">                                             </span><span class="istickedoff"><span class="nottickedoff">| (_, _, Just solution) &lt;- solutions ]</span></span>
<span class="lineno">  324 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">case solutions' of</span></span>
<span class="lineno">  325 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">[solution] -&gt;</span></span>
<span class="lineno">  326 </span><span class="spaces">                                    </span><span class="istickedoff"><span class="nottickedoff">copySolution solution (essenceDir</span></span>
<span class="lineno">  327 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;/&gt; intercalate &quot;-&quot; [ essenceBasename</span></span>
<span class="lineno">  328 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  329 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;.&gt; &quot;.solution&quot;)</span></span>
<span class="lineno">  330 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">_ -&gt; forM_ (zip allNats solutions') $ \ (i, solution) -&gt;</span></span>
<span class="lineno">  331 </span><span class="spaces">                                    </span><span class="istickedoff"><span class="nottickedoff">copySolution solution (essenceDir</span></span>
<span class="lineno">  332 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;/&gt; intercalate &quot;-&quot; [ essenceBasename</span></span>
<span class="lineno">  333 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">, padLeft 6 '0' (show i)</span></span>
<span class="lineno">  334 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  335 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;.&gt; &quot;.solution&quot;)</span></span>
<span class="lineno">  336 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">else forM_ essenceParams $ \ essenceParam -&gt; do</span></span>
<span class="lineno">  337 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let (_paramDir, paramFilename) = splitFileName essenceParam</span></span>
<span class="lineno">  338 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let paramBasename = takeBaseName paramFilename</span></span>
<span class="lineno">  339 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let solutions' = [ solution</span></span>
<span class="lineno">  340 </span><span class="spaces">                                             </span><span class="istickedoff"><span class="nottickedoff">| (_, essenceParam', Just solution) &lt;- solutions</span></span>
<span class="lineno">  341 </span><span class="spaces">                                             </span><span class="istickedoff"><span class="nottickedoff">, essenceParam == essenceParam' ]</span></span>
<span class="lineno">  342 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">case solutions' of</span></span>
<span class="lineno">  343 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">[solution] -&gt;</span></span>
<span class="lineno">  344 </span><span class="spaces">                                    </span><span class="istickedoff"><span class="nottickedoff">copySolution solution (essenceDir</span></span>
<span class="lineno">  345 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;/&gt; intercalate &quot;-&quot; [ essenceBasename</span></span>
<span class="lineno">  346 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">, paramBasename</span></span>
<span class="lineno">  347 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  348 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;.&gt; &quot;.solution&quot;)</span></span>
<span class="lineno">  349 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">_ -&gt; forM_ (zip allNats solutions') $ \ (i, solution) -&gt;</span></span>
<span class="lineno">  350 </span><span class="spaces">                                    </span><span class="istickedoff"><span class="nottickedoff">copySolution solution (essenceDir</span></span>
<span class="lineno">  351 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;/&gt; intercalate &quot;-&quot; [ essenceBasename</span></span>
<span class="lineno">  352 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">, paramBasename</span></span>
<span class="lineno">  353 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">, padLeft 6 '0' (show i)</span></span>
<span class="lineno">  354 </span><span class="spaces">                                                                                </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  355 </span><span class="spaces">                                                            </span><span class="istickedoff"><span class="nottickedoff">&lt;.&gt; &quot;.solution&quot;)</span></span>
<span class="lineno">  356 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  357 </span><span class="spaces">    </span><span class="istickedoff">liftIO stopGlobalPool</span>
<span class="lineno">  358 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  359 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  360 </span><span class="spaces">        </span><span class="istickedoff">conjuring :: m [FilePath]</span>
<span class="lineno">  361 </span><span class="spaces">        </span><span class="istickedoff">conjuring = do</span>
<span class="lineno">  362 </span><span class="spaces">            </span><span class="istickedoff">pp logLevel $ <span class="nottickedoff">&quot;Generating models for&quot; &lt;+&gt; pretty essence</span></span>
<span class="lineno">  363 </span><span class="spaces">            </span><span class="istickedoff">liftIO $ removeDirectoryIfExists outputDirectory</span>
<span class="lineno">  364 </span><span class="spaces">            </span><span class="istickedoff">let modelling = let <span class="nottickedoff">savedChoices = def</span></span>
<span class="lineno">  365 </span><span class="spaces">                                </span><span class="istickedoff">estimateNumberOfModels = False</span>
<span class="lineno">  366 </span><span class="spaces">                            </span><span class="istickedoff">in  <span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">Modelling{..}</span></span></span></span></span></span>                   -- construct a Modelling UI, copying all relevant fields</span>
<span class="lineno">  367 </span><span class="spaces">                                                                </span><span class="istickedoff">-- from the given Solve UI</span>
<span class="lineno">  368 </span><span class="spaces">            </span><span class="istickedoff">n &lt;- mainWithArgs_Modelling &quot;&quot; modelling Nothing S.empty</span>
<span class="lineno">  369 </span><span class="spaces">            </span><span class="istickedoff">eprimes &lt;- getEprimes</span>
<span class="lineno">  370 </span><span class="spaces">            </span><span class="istickedoff">when (null eprimes) $ <span class="nottickedoff">bug &quot;Failed to generate models.&quot;</span></span>
<span class="lineno">  371 </span><span class="spaces">            </span><span class="istickedoff">if <span class="tickonlytrue">(S.size n == 1)</span></span>
<span class="lineno">  372 </span><span class="spaces">                </span><span class="istickedoff">then pp logLevel $ <span class="nottickedoff">&quot;Generated models:&quot; &lt;+&gt; prettyList id &quot;,&quot; eprimes</span></span>
<span class="lineno">  373 </span><span class="spaces">                </span><span class="istickedoff">else <span class="nottickedoff">pp logLevel $ &quot;Generated&quot; &lt;+&gt; pretty (S.size n) &lt;+&gt; &quot;models:&quot; &lt;+&gt; prettyList id &quot;,&quot; eprimes</span></span>
<span class="lineno">  374 </span><span class="spaces">            </span><span class="istickedoff">pp logLevel $ <span class="nottickedoff">&quot;Saved under:&quot; &lt;+&gt; pretty outputDirectory</span></span>
<span class="lineno">  375 </span><span class="spaces">            </span><span class="istickedoff">return eprimes</span>
<span class="lineno">  376 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  377 </span><span class="spaces">        </span><span class="istickedoff">getEprimes :: m [FilePath]</span>
<span class="lineno">  378 </span><span class="spaces">        </span><span class="istickedoff">getEprimes = sort . filter (&quot;.eprime&quot; `isSuffixOf`) &lt;$&gt; liftIO (getDirectoryContents outputDirectory)</span>
<span class="lineno">  379 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  380 </span><span class="spaces">        </span><span class="istickedoff">combineResults :: [Either e [a]] -&gt; Either e [a]</span>
<span class="lineno">  381 </span><span class="spaces">        </span><span class="istickedoff">combineResults = fmap concat . sequence</span>
<span class="lineno">  382 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  383 </span><span class="spaces">        </span><span class="istickedoff">savileRows</span>
<span class="lineno">  384 </span><span class="spaces">            </span><span class="istickedoff">:: [(FilePath, Model)]      -- models</span>
<span class="lineno">  385 </span><span class="spaces">            </span><span class="istickedoff">-&gt; [(FilePath, Model)]      -- params</span>
<span class="lineno">  386 </span><span class="spaces">            </span><span class="istickedoff">-&gt; IO (Either [Doc] [(FilePath, FilePath, Maybe FilePath)])</span>
<span class="lineno">  387 </span><span class="spaces">        </span><span class="istickedoff">savileRows eprimes params = fmap combineResults $</span>
<span class="lineno">  388 </span><span class="spaces">            </span><span class="istickedoff">if <span class="tickonlytrue">null params</span></span>
<span class="lineno">  389 </span><span class="spaces">                </span><span class="istickedoff">then autoParallel [ savileRowNoParam config m</span>
<span class="lineno">  390 </span><span class="spaces">                                  </span><span class="istickedoff">| m &lt;- eprimes</span>
<span class="lineno">  391 </span><span class="spaces">                                  </span><span class="istickedoff">]</span>
<span class="lineno">  392 </span><span class="spaces">                </span><span class="istickedoff">else <span class="nottickedoff">autoParallel [ savileRowWithParams config m p</span></span>
<span class="lineno">  393 </span><span class="spaces">                                  </span><span class="istickedoff"><span class="nottickedoff">| m &lt;- eprimes</span></span>
<span class="lineno">  394 </span><span class="spaces">                                  </span><span class="istickedoff"><span class="nottickedoff">, p &lt;- params</span></span>
<span class="lineno">  395 </span><span class="spaces">                                  </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  396 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  397 </span><span class="spaces">        </span><span class="istickedoff">validating :: [(FilePath, FilePath, Maybe FilePath)] -&gt; IO ()</span>
<span class="lineno">  398 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">validating solutions =</span></span>
<span class="lineno">  399 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">if null essenceParams</span></span>
<span class="lineno">  400 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">then autoParallel_ [ validateSolutionNoParam config sol</span></span>
<span class="lineno">  401 </span><span class="spaces">                                   </span><span class="istickedoff"><span class="nottickedoff">| (_, _, Just sol) &lt;- solutions ]</span></span>
<span class="lineno">  402 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">else autoParallel_ [ validateSolutionWithParams config sol p</span></span>
<span class="lineno">  403 </span><span class="spaces">                                   </span><span class="istickedoff"><span class="nottickedoff">| (_, p, Just sol) &lt;- solutions ]</span></span></span>
<span class="lineno">  404 </span>
<span class="lineno">  405 </span>
<span class="lineno">  406 </span>mainWithArgs_Modelling :: forall m .
<span class="lineno">  407 </span>    MonadIO m =&gt;
<span class="lineno">  408 </span>    MonadLog m =&gt;
<span class="lineno">  409 </span>    MonadFail m =&gt;
<span class="lineno">  410 </span>    EnumerateDomain m =&gt;
<span class="lineno">  411 </span>    (?typeCheckerMode :: TypeCheckerMode) =&gt;
<span class="lineno">  412 </span>    String -&gt;                   -- modelNamePrefix
<span class="lineno">  413 </span>    UI -&gt;
<span class="lineno">  414 </span>    Maybe Int -&gt;                -- portfolioSize for the recursive call
<span class="lineno">  415 </span>    S.Set Int -&gt;                -- modelHashesBefore
<span class="lineno">  416 </span>    m (S.Set Int)
<span class="lineno">  417 </span><span class="decl"><span class="istickedoff">mainWithArgs_Modelling _ mode@Modelling{..} _ modelHashesBefore | Just portfolioSize &lt;- portfolio = <span class="nottickedoff">do</span></span>
<span class="lineno">  418 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">pp logLevel $ &quot;Running in portfolio mode, aiming to generate&quot; &lt;+&gt; pretty portfolioSize &lt;+&gt; &quot;models.&quot;</span></span>
<span class="lineno">  419 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">let</span></span>
<span class="lineno">  420 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">go modelsSoFar [] = do</span></span>
<span class="lineno">  421 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">pp logLevel $ &quot;Done, no more levels, generated&quot; &lt;+&gt; pretty (S.size modelsSoFar) &lt;+&gt; &quot;models.&quot;</span></span>
<span class="lineno">  422 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">return modelsSoFar</span></span>
<span class="lineno">  423 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">go modelsSoFar (l:ls) = do</span></span>
<span class="lineno">  424 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">let nbModelsNeeded = portfolioSize - S.size modelsSoFar</span></span>
<span class="lineno">  425 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">if nbModelsNeeded &lt;= 0</span></span>
<span class="lineno">  426 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">then return modelsSoFar</span></span>
<span class="lineno">  427 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">else do</span></span>
<span class="lineno">  428 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">modelsSoFar' &lt;- l (Just portfolioSize) modelsSoFar</span></span>
<span class="lineno">  429 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">go modelsSoFar' ls</span></span>
<span class="lineno">  430 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"></span></span>
<span class="lineno">  431 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">go modelHashesBefore</span></span>
<span class="lineno">  432 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">[ mainWithArgs_Modelling &quot;01_compact&quot;</span></span>
<span class="lineno">  433 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  434 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;c&quot;</span></span>
<span class="lineno">  435 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;c&quot;</span></span>
<span class="lineno">  436 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;c&quot;</span></span>
<span class="lineno">  437 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  438 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;c&quot;</span></span>
<span class="lineno">  439 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;c&quot;</span></span>
<span class="lineno">  440 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;c&quot;</span></span>
<span class="lineno">  441 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = False</span></span>
<span class="lineno">  442 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = True</span></span>
<span class="lineno">  443 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  444 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  445 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;02_compact&quot;</span></span>
<span class="lineno">  446 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  447 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;c&quot;</span></span>
<span class="lineno">  448 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;c&quot;</span></span>
<span class="lineno">  449 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;c&quot;</span></span>
<span class="lineno">  450 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;c&quot;</span></span>
<span class="lineno">  451 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;c&quot;</span></span>
<span class="lineno">  452 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;c&quot;</span></span>
<span class="lineno">  453 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;c&quot;</span></span>
<span class="lineno">  454 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = False</span></span>
<span class="lineno">  455 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = True</span></span>
<span class="lineno">  456 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  457 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  458 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;03_sparse&quot;</span></span>
<span class="lineno">  459 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  460 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;s&quot;</span></span>
<span class="lineno">  461 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;s&quot;</span></span>
<span class="lineno">  462 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;s&quot;</span></span>
<span class="lineno">  463 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  464 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;s&quot;</span></span>
<span class="lineno">  465 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;s&quot;</span></span>
<span class="lineno">  466 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;s&quot;</span></span>
<span class="lineno">  467 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = False</span></span>
<span class="lineno">  468 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = True</span></span>
<span class="lineno">  469 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  470 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  471 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;04_nochPrunedLevels&quot;</span></span>
<span class="lineno">  472 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  473 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  474 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  475 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  476 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  477 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;c&quot;</span></span>
<span class="lineno">  478 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;c&quot;</span></span>
<span class="lineno">  479 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;c&quot;</span></span>
<span class="lineno">  480 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = False</span></span>
<span class="lineno">  481 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = True</span></span>
<span class="lineno">  482 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  483 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  484 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;05_nochAllLevels&quot;</span></span>
<span class="lineno">  485 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  486 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  487 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  488 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  489 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  490 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;c&quot;</span></span>
<span class="lineno">  491 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;c&quot;</span></span>
<span class="lineno">  492 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;c&quot;</span></span>
<span class="lineno">  493 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = False</span></span>
<span class="lineno">  494 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = False</span></span>
<span class="lineno">  495 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  496 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  497 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;06_chPrunedLevels&quot;</span></span>
<span class="lineno">  498 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  499 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  500 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  501 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  502 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  503 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;c&quot;</span></span>
<span class="lineno">  504 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;c&quot;</span></span>
<span class="lineno">  505 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;c&quot;</span></span>
<span class="lineno">  506 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = True</span></span>
<span class="lineno">  507 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = True</span></span>
<span class="lineno">  508 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  509 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  510 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;07_chAllLevels&quot;</span></span>
<span class="lineno">  511 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  512 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  513 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  514 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  515 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  516 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;c&quot;</span></span>
<span class="lineno">  517 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;c&quot;</span></span>
<span class="lineno">  518 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;c&quot;</span></span>
<span class="lineno">  519 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = True</span></span>
<span class="lineno">  520 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = False</span></span>
<span class="lineno">  521 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  522 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  523 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;08_fullPrunedLevels&quot;</span></span>
<span class="lineno">  524 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  525 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  526 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  527 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  528 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  529 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;x&quot;</span></span>
<span class="lineno">  530 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;x&quot;</span></span>
<span class="lineno">  531 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;x&quot;</span></span>
<span class="lineno">  532 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = True</span></span>
<span class="lineno">  533 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = True</span></span>
<span class="lineno">  534 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  535 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  536 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;09_fullAllLevels&quot;</span></span>
<span class="lineno">  537 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  538 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  539 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  540 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  541 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;s&quot;</span></span>
<span class="lineno">  542 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;x&quot;</span></span>
<span class="lineno">  543 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;x&quot;</span></span>
<span class="lineno">  544 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;x&quot;</span></span>
<span class="lineno">  545 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = True</span></span>
<span class="lineno">  546 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = False</span></span>
<span class="lineno">  547 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  548 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  549 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;10_fullParamsPrunedLevels&quot;</span></span>
<span class="lineno">  550 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  551 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  552 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  553 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  554 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;x&quot;</span></span>
<span class="lineno">  555 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;x&quot;</span></span>
<span class="lineno">  556 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;x&quot;</span></span>
<span class="lineno">  557 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;x&quot;</span></span>
<span class="lineno">  558 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = True</span></span>
<span class="lineno">  559 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = True</span></span>
<span class="lineno">  560 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  561 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  562 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">, mainWithArgs_Modelling &quot;11_fullParamsAllLevels&quot;</span></span>
<span class="lineno">  563 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">mode { portfolio = Nothing</span></span>
<span class="lineno">  564 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, strategyA = &quot;x&quot;</span></span>
<span class="lineno">  565 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representations = Just &quot;x&quot;</span></span>
<span class="lineno">  566 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsFinds = Just &quot;x&quot;</span></span>
<span class="lineno">  567 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsGivens = Just &quot;x&quot;</span></span>
<span class="lineno">  568 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsAuxiliaries = Just &quot;x&quot;</span></span>
<span class="lineno">  569 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsQuantifieds = Just &quot;x&quot;</span></span>
<span class="lineno">  570 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationsCuts = Just &quot;x&quot;</span></span>
<span class="lineno">  571 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, channelling = True</span></span>
<span class="lineno">  572 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, representationLevels = False</span></span>
<span class="lineno">  573 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">, smartFilenames = True</span></span>
<span class="lineno">  574 </span><span class="spaces">                 </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  575 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  576 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs_Modelling &quot;&quot; mode portfolioSize modelHashesBefore =</span>
<span class="lineno">  577 </span><span class="spaces">    </span><span class="istickedoff">mainWithArgs_Modelling &quot;model&quot; mode portfolioSize modelHashesBefore</span>
<span class="lineno">  578 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs_Modelling modelNamePrefix Modelling{..} portfolioSize modelHashesBefore = do</span>
<span class="lineno">  579 </span><span class="spaces">    </span><span class="istickedoff">unless (modelNamePrefix == &quot;model&quot;) $</span>
<span class="lineno">  580 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">pp logLevel $ &quot;Portfolio level:&quot; &lt;+&gt; pretty modelNamePrefix</span></span>
<span class="lineno">  581 </span><span class="spaces">    </span><span class="istickedoff">let</span>
<span class="lineno">  582 </span><span class="spaces">        </span><span class="istickedoff">parseStrategy_ s = maybe <span class="nottickedoff">(userErr1 (&quot;Not a valid strategy:&quot; &lt;+&gt; pretty s))</span></span>
<span class="lineno">  583 </span><span class="spaces">                                 </span><span class="istickedoff">return</span>
<span class="lineno">  584 </span><span class="spaces">                                 </span><span class="istickedoff">(parseStrategy s)</span>
<span class="lineno">  585 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  586 </span><span class="spaces">        </span><span class="istickedoff">getConfig = do</span>
<span class="lineno">  587 </span><span class="spaces">            </span><span class="istickedoff">strategyQ'                  &lt;- parseStrategy_ strategyQ</span>
<span class="lineno">  588 </span><span class="spaces">            </span><span class="istickedoff">strategyA'                  &lt;- parseStrategy_ strategyA</span>
<span class="lineno">  589 </span><span class="spaces">            </span><span class="istickedoff">representations'            &lt;- maybe (return strategyA')       <span class="nottickedoff">parseStrategy_</span> representations</span>
<span class="lineno">  590 </span><span class="spaces">            </span><span class="istickedoff">representationsFinds'       &lt;- maybe (return representations') <span class="nottickedoff">parseStrategy_</span> representationsFinds</span>
<span class="lineno">  591 </span><span class="spaces">            </span><span class="istickedoff">representationsGivens'      &lt;- maybe (return Sparse          ) <span class="nottickedoff">parseStrategy_</span> representationsGivens</span>
<span class="lineno">  592 </span><span class="spaces">            </span><span class="istickedoff">representationsAuxiliaries' &lt;- maybe (return representations') <span class="nottickedoff">parseStrategy_</span> representationsAuxiliaries</span>
<span class="lineno">  593 </span><span class="spaces">            </span><span class="istickedoff">representationsQuantifieds' &lt;- maybe (return representations') <span class="nottickedoff">parseStrategy_</span> representationsQuantifieds</span>
<span class="lineno">  594 </span><span class="spaces">            </span><span class="istickedoff">representationsCuts'        &lt;- maybe (return <span class="nottickedoff">representations'</span>) <span class="nottickedoff">parseStrategy_</span> representationsCuts</span>
<span class="lineno">  595 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  596 </span><span class="spaces">            </span><span class="istickedoff">case fst (viewAuto strategyQ') of</span>
<span class="lineno">  597 </span><span class="spaces">                </span><span class="istickedoff">Compact -&gt; <span class="nottickedoff">userErr1 &quot;The Compact heuristic isn't supported for questions.&quot;</span></span>
<span class="lineno">  598 </span><span class="spaces">                </span><span class="istickedoff">_       -&gt; return <span class="nottickedoff">()</span></span>
<span class="lineno">  599 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  600 </span><span class="spaces">            </span><span class="istickedoff">let</span>
<span class="lineno">  601 </span><span class="spaces">                </span><span class="istickedoff">parseCommaSeparated :: Read a =&gt; Doc -&gt; String -&gt; m (Maybe [a])</span>
<span class="lineno">  602 </span><span class="spaces">                </span><span class="istickedoff">parseCommaSeparated flag str =</span>
<span class="lineno">  603 </span><span class="spaces">                    </span><span class="istickedoff">if <span class="tickonlytrue">null str</span></span>
<span class="lineno">  604 </span><span class="spaces">                        </span><span class="istickedoff">then return <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  605 </span><span class="spaces">                        </span><span class="istickedoff">else <span class="nottickedoff">do</span></span>
<span class="lineno">  606 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let parts = splitOn &quot;,&quot; str</span></span>
<span class="lineno">  607 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let intParts = mapMaybe readMay parts</span></span>
<span class="lineno">  608 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">if length parts == length intParts</span></span>
<span class="lineno">  609 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">then return (Just intParts)</span></span>
<span class="lineno">  610 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">else userErr1 $ vcat [ &quot;Cannot parse the value for&quot; &lt;+&gt; flag</span></span>
<span class="lineno">  611 </span><span class="spaces">                                                     </span><span class="istickedoff"><span class="nottickedoff">, &quot;Expected a comma separated list of integers.&quot;</span></span>
<span class="lineno">  612 </span><span class="spaces">                                                     </span><span class="istickedoff"><span class="nottickedoff">, &quot;But got:&quot; &lt;+&gt; pretty str</span></span>
<span class="lineno">  613 </span><span class="spaces">                                                     </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  614 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  615 </span><span class="spaces">            </span><span class="istickedoff">responsesList &lt;- parseCommaSeparated <span class="nottickedoff">&quot;--responses&quot;</span> responses</span>
<span class="lineno">  616 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  617 </span><span class="spaces">            </span><span class="istickedoff">responsesRepresentationList &lt;- do</span>
<span class="lineno">  618 </span><span class="spaces">                </span><span class="istickedoff">if <span class="tickonlytrue">null responsesRepresentation</span></span>
<span class="lineno">  619 </span><span class="spaces">                    </span><span class="istickedoff">then return <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  620 </span><span class="spaces">                    </span><span class="istickedoff">else <span class="nottickedoff">do</span></span>
<span class="lineno">  621 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">let parts =</span></span>
<span class="lineno">  622 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">[ case splitOn &quot;:&quot; pair of</span></span>
<span class="lineno">  623 </span><span class="spaces">                                    </span><span class="istickedoff"><span class="nottickedoff">[nm, val] -&gt;</span></span>
<span class="lineno">  624 </span><span class="spaces">                                        </span><span class="istickedoff"><span class="nottickedoff">case readMay val of</span></span>
<span class="lineno">  625 </span><span class="spaces">                                            </span><span class="istickedoff"><span class="nottickedoff">Just i -&gt; Just (Name (stringToText nm), i)</span></span>
<span class="lineno">  626 </span><span class="spaces">                                            </span><span class="istickedoff"><span class="nottickedoff">Nothing -&gt; Nothing</span></span>
<span class="lineno">  627 </span><span class="spaces">                                    </span><span class="istickedoff"><span class="nottickedoff">_ -&gt; Nothing</span></span>
<span class="lineno">  628 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">| pair &lt;- splitOn &quot;,&quot; responsesRepresentation</span></span>
<span class="lineno">  629 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  630 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">let partsJust = catMaybes parts</span></span>
<span class="lineno">  631 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">if length parts == length partsJust</span></span>
<span class="lineno">  632 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">then return (Just partsJust)</span></span>
<span class="lineno">  633 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">else userErr1 $ vcat [ &quot;Cannot parse the value for --responses-representation.&quot;</span></span>
<span class="lineno">  634 </span><span class="spaces">                                                 </span><span class="istickedoff"><span class="nottickedoff">, &quot;Expected a comma separated list of variable name : integer pairs.&quot;</span></span>
<span class="lineno">  635 </span><span class="spaces">                                                 </span><span class="istickedoff"><span class="nottickedoff">, &quot;But got:&quot; &lt;+&gt; pretty responsesRepresentation</span></span>
<span class="lineno">  636 </span><span class="spaces">                                                 </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  637 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  638 </span><span class="spaces">            </span><span class="istickedoff">return Config.Config</span>
<span class="lineno">  639 </span><span class="spaces">                </span><span class="istickedoff">{ Config.outputDirectory            = outputDirectory</span>
<span class="lineno">  640 </span><span class="spaces">                </span><span class="istickedoff">, Config.logLevel                   = <span class="nottickedoff">logLevel</span></span>
<span class="lineno">  641 </span><span class="spaces">                </span><span class="istickedoff">, Config.verboseTrail               = verboseTrail</span>
<span class="lineno">  642 </span><span class="spaces">                </span><span class="istickedoff">, Config.rewritesTrail              = rewritesTrail</span>
<span class="lineno">  643 </span><span class="spaces">                </span><span class="istickedoff">, Config.logRuleFails               = logRuleFails</span>
<span class="lineno">  644 </span><span class="spaces">                </span><span class="istickedoff">, Config.logRuleSuccesses           = logRuleSuccesses</span>
<span class="lineno">  645 </span><span class="spaces">                </span><span class="istickedoff">, Config.logRuleAttempts            = logRuleAttempts</span>
<span class="lineno">  646 </span><span class="spaces">                </span><span class="istickedoff">, Config.logChoices                 = <span class="nottickedoff">logChoices</span></span>
<span class="lineno">  647 </span><span class="spaces">                </span><span class="istickedoff">, Config.strategyQ                  = strategyQ'</span>
<span class="lineno">  648 </span><span class="spaces">                </span><span class="istickedoff">, Config.strategyA                  = strategyA'</span>
<span class="lineno">  649 </span><span class="spaces">                </span><span class="istickedoff">, Config.representations            = <span class="nottickedoff">representations'</span></span>
<span class="lineno">  650 </span><span class="spaces">                </span><span class="istickedoff">, Config.representationsFinds       = representationsFinds'</span>
<span class="lineno">  651 </span><span class="spaces">                </span><span class="istickedoff">, Config.representationsGivens      = representationsGivens'</span>
<span class="lineno">  652 </span><span class="spaces">                </span><span class="istickedoff">, Config.representationsAuxiliaries = representationsAuxiliaries'</span>
<span class="lineno">  653 </span><span class="spaces">                </span><span class="istickedoff">, Config.representationsQuantifieds = representationsQuantifieds'</span>
<span class="lineno">  654 </span><span class="spaces">                </span><span class="istickedoff">, Config.representationsCuts        = <span class="nottickedoff">representationsCuts'</span></span>
<span class="lineno">  655 </span><span class="spaces">                </span><span class="istickedoff">, Config.channelling                = channelling</span>
<span class="lineno">  656 </span><span class="spaces">                </span><span class="istickedoff">, Config.representationLevels       = representationLevels</span>
<span class="lineno">  657 </span><span class="spaces">                </span><span class="istickedoff">, Config.limitModels                = if <span class="tickonlyfalse">limitModels == Just <span class="nottickedoff">0</span></span> then <span class="nottickedoff">Nothing</span> else limitModels</span>
<span class="lineno">  658 </span><span class="spaces">                </span><span class="istickedoff">, Config.numberingStart             = numberingStart</span>
<span class="lineno">  659 </span><span class="spaces">                </span><span class="istickedoff">, Config.smartFilenames             = smartFilenames</span>
<span class="lineno">  660 </span><span class="spaces">                </span><span class="istickedoff">, Config.lineWidth                  = lineWidth</span>
<span class="lineno">  661 </span><span class="spaces">                </span><span class="istickedoff">, Config.responses                  = <span class="nottickedoff">responsesList</span></span>
<span class="lineno">  662 </span><span class="spaces">                </span><span class="istickedoff">, Config.responsesRepresentation    = <span class="nottickedoff">responsesRepresentationList</span></span>
<span class="lineno">  663 </span><span class="spaces">                </span><span class="istickedoff">, Config.estimateNumberOfModels     = estimateNumberOfModels</span>
<span class="lineno">  664 </span><span class="spaces">                </span><span class="istickedoff">}</span>
<span class="lineno">  665 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  666 </span><span class="spaces">    </span><span class="istickedoff">essenceM &lt;- readModelFromFile essence</span>
<span class="lineno">  667 </span><span class="spaces">    </span><span class="istickedoff">liftIO $ hSetBuffering stdout LineBuffering</span>
<span class="lineno">  668 </span><span class="spaces">    </span><span class="istickedoff">liftIO $ maybe (return <span class="nottickedoff">()</span>) <span class="nottickedoff">setRandomSeed</span> seed</span>
<span class="lineno">  669 </span><span class="spaces">    </span><span class="istickedoff">let</span>
<span class="lineno">  670 </span><span class="spaces">        </span><span class="istickedoff">conjuring = do</span>
<span class="lineno">  671 </span><span class="spaces">            </span><span class="istickedoff">config &lt;- getConfig</span>
<span class="lineno">  672 </span><span class="spaces">            </span><span class="istickedoff">runNameGen essenceM $ outputModels portfolioSize modelHashesBefore modelNamePrefix config essenceM</span>
<span class="lineno">  673 </span><span class="spaces">    </span><span class="istickedoff">conjuring</span>
<span class="lineno">  674 </span><span class="spaces"></span><span class="istickedoff">mainWithArgs_Modelling _ _ _ _ = <span class="nottickedoff">bug &quot;mainWithArgs_Modelling&quot;</span></span></span>
<span class="lineno">  675 </span>
<span class="lineno">  676 </span>pp :: MonadIO m =&gt; LogLevel -&gt; Doc -&gt; m ()
<span class="lineno">  677 </span><span class="decl"><span class="istickedoff">pp LogNone = const $ return <span class="nottickedoff">()</span></span>
<span class="lineno">  678 </span><span class="spaces"></span><span class="istickedoff">pp _       = <span class="nottickedoff">liftIO . putStrLn . renderNormal</span></span></span>
<span class="lineno">  679 </span>
<span class="lineno">  680 </span>
<span class="lineno">  681 </span>savilerowScriptName :: Sys.FilePath
<span class="lineno">  682 </span><span class="decl"><span class="istickedoff">savilerowScriptName</span>
<span class="lineno">  683 </span><span class="spaces">    </span><span class="istickedoff">| <span class="tickonlytrue">os `elem` [&quot;darwin&quot;, &quot;linux&quot;]</span> = &quot;savilerow&quot;</span>
<span class="lineno">  684 </span><span class="spaces">    </span><span class="istickedoff">| <span class="nottickedoff">os `elem` [&quot;mingw32&quot;]</span> = <span class="nottickedoff">&quot;savilerow.bat&quot;</span></span>
<span class="lineno">  685 </span><span class="spaces">    </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> = <span class="nottickedoff">bug &quot;Cannot detect operating system.&quot;</span></span></span>
<span class="lineno">  686 </span>
<span class="lineno">  687 </span>
<span class="lineno">  688 </span>quoteMultiWord :: String -&gt; String
<span class="lineno">  689 </span><span class="decl"><span class="nottickedoff">quoteMultiWord s</span>
<span class="lineno">  690 </span><span class="spaces">    </span><span class="nottickedoff">| ' ' `elem` s = &quot;\&quot;&quot; ++ s ++ &quot;\&quot;&quot;</span>
<span class="lineno">  691 </span><span class="spaces">    </span><span class="nottickedoff">| otherwise = s</span></span>
<span class="lineno">  692 </span>
<span class="lineno">  693 </span>
<span class="lineno">  694 </span>savileRowNoParam ::
<span class="lineno">  695 </span>    (?typeCheckerMode :: TypeCheckerMode) =&gt;
<span class="lineno">  696 </span>    UI -&gt;
<span class="lineno">  697 </span>    (FilePath, Model) -&gt;        -- model
<span class="lineno">  698 </span>    IO (Either
<span class="lineno">  699 </span>     [Doc]                      -- user error
<span class="lineno">  700 </span>     [ ( FilePath               -- model
<span class="lineno">  701 </span>       , FilePath               -- param
<span class="lineno">  702 </span>       , Maybe FilePath         -- solution, Nothing if solutionsInOneFile=True
<span class="lineno">  703 </span>       ) ])
<span class="lineno">  704 </span><span class="decl"><span class="istickedoff">savileRowNoParam ui@Solve{..} (modelPath, eprimeModel) = sh $ errExit False $ do</span>
<span class="lineno">  705 </span><span class="spaces">    </span><span class="istickedoff">pp logLevel $ <span class="nottickedoff">hsep [&quot;Savile Row:&quot;, pretty modelPath]</span></span>
<span class="lineno">  706 </span><span class="spaces">    </span><span class="istickedoff">let outBase = dropExtension modelPath</span>
<span class="lineno">  707 </span><span class="spaces">    </span><span class="istickedoff">srArgs &lt;- liftIO $ srMkArgs ui outBase modelPath</span>
<span class="lineno">  708 </span><span class="spaces">    </span><span class="istickedoff">let tr = translateSolution eprimeModel def</span>
<span class="lineno">  709 </span><span class="spaces">    </span><span class="istickedoff">when (logLevel &gt;= LogDebug) $ <span class="nottickedoff">do</span></span>
<span class="lineno">  710 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">liftIO $ putStrLn &quot;Using the following options for Savile Row:&quot;</span></span>
<span class="lineno">  711 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">liftIO $ putStrLn $ &quot;    savilerow &quot; ++ unwords (map (quoteMultiWord . textToString) srArgs)</span></span>
<span class="lineno">  712 </span><span class="spaces">    </span><span class="istickedoff">(stdoutSR, solutions) &lt;- partitionEithers &lt;$&gt; runHandle savilerowScriptName srArgs</span>
<span class="lineno">  713 </span><span class="spaces">                                </span><span class="istickedoff">(liftIO . srStdoutHandler</span>
<span class="lineno">  714 </span><span class="spaces">                                    </span><span class="istickedoff">(outBase, <span class="nottickedoff">modelPath</span>, <span class="nottickedoff">&quot;&lt;no param file&gt;&quot;</span>, ui)</span>
<span class="lineno">  715 </span><span class="spaces">                                    </span><span class="istickedoff">tr (1::Int))</span>
<span class="lineno">  716 </span><span class="spaces">    </span><span class="istickedoff">srCleanUp (stringToText $ unlines stdoutSR) solutions</span>
<span class="lineno">  717 </span><span class="spaces"></span><span class="istickedoff">savileRowNoParam _ _ = <span class="nottickedoff">bug &quot;savileRowNoParam&quot;</span></span></span>
<span class="lineno">  718 </span>
<span class="lineno">  719 </span>
<span class="lineno">  720 </span>savileRowWithParams ::
<span class="lineno">  721 </span>    (?typeCheckerMode :: TypeCheckerMode) =&gt;
<span class="lineno">  722 </span>    UI -&gt;
<span class="lineno">  723 </span>    (FilePath, Model) -&gt;        -- model
<span class="lineno">  724 </span>    (FilePath, Model) -&gt;        -- param
<span class="lineno">  725 </span>    IO (Either
<span class="lineno">  726 </span>     [Doc]                      -- user error
<span class="lineno">  727 </span>     [ ( FilePath               -- model
<span class="lineno">  728 </span>       , FilePath               -- param
<span class="lineno">  729 </span>       , Maybe FilePath         -- solution, Nothing if solutionsInOneFile=True
<span class="lineno">  730 </span>       ) ])
<span class="lineno">  731 </span><span class="decl"><span class="nottickedoff">savileRowWithParams ui@Solve{..} (modelPath, eprimeModel) (paramPath, essenceParam) = sh $ errExit False $ do</span>
<span class="lineno">  732 </span><span class="spaces">    </span><span class="nottickedoff">pp logLevel $ hsep [&quot;Savile Row:&quot;, pretty modelPath, pretty paramPath]</span>
<span class="lineno">  733 </span><span class="spaces">    </span><span class="nottickedoff">let outBase = dropExtension modelPath ++ &quot;-&quot; ++ dropDirs (dropExtension paramPath)</span>
<span class="lineno">  734 </span><span class="spaces">    </span><span class="nottickedoff">let</span>
<span class="lineno">  735 </span><span class="spaces">        </span><span class="nottickedoff">-- this is a bit tricky.</span>
<span class="lineno">  736 </span><span class="spaces">        </span><span class="nottickedoff">-- we want to preserve user-erors, and not raise them as errors using IO.fail</span>
<span class="lineno">  737 </span><span class="spaces">        </span><span class="nottickedoff">runTranslateParameter :: IO (Either [Doc] Model)</span>
<span class="lineno">  738 </span><span class="spaces">        </span><span class="nottickedoff">runTranslateParameter = runUserErrorT $ ignoreLogs $ runNameGen () $</span>
<span class="lineno">  739 </span><span class="spaces">                                    </span><span class="nottickedoff">translateParameter graphSolver eprimeModel essenceParam</span>
<span class="lineno">  740 </span><span class="spaces">    </span><span class="nottickedoff">eprimeParam' &lt;- liftIO runTranslateParameter</span>
<span class="lineno">  741 </span><span class="spaces">    </span><span class="nottickedoff">case eprimeParam' of</span>
<span class="lineno">  742 </span><span class="spaces">        </span><span class="nottickedoff">Left err -&gt; return (Left err)</span>
<span class="lineno">  743 </span><span class="spaces">        </span><span class="nottickedoff">Right eprimeParam -&gt; do</span>
<span class="lineno">  744 </span><span class="spaces">            </span><span class="nottickedoff">liftIO $ writeFile (outputDirectory &lt;/&gt; outBase ++ &quot;.eprime-param&quot;) (render lineWidth eprimeParam)</span>
<span class="lineno">  745 </span><span class="spaces">            </span><span class="nottickedoff">srArgsBase &lt;- liftIO $ srMkArgs ui outBase modelPath</span>
<span class="lineno">  746 </span><span class="spaces">            </span><span class="nottickedoff">let srArgs = &quot;-in-param&quot;</span>
<span class="lineno">  747 </span><span class="spaces">                       </span><span class="nottickedoff">: stringToText (outputDirectory &lt;/&gt; outBase ++ &quot;.eprime-param&quot;)</span>
<span class="lineno">  748 </span><span class="spaces">                       </span><span class="nottickedoff">: srArgsBase</span>
<span class="lineno">  749 </span><span class="spaces">            </span><span class="nottickedoff">let tr = translateSolution eprimeModel essenceParam</span>
<span class="lineno">  750 </span><span class="spaces">            </span><span class="nottickedoff">when (logLevel &gt;= LogDebug) $ do</span>
<span class="lineno">  751 </span><span class="spaces">                </span><span class="nottickedoff">liftIO $ putStrLn &quot;Using the following options for Savile Row:&quot;</span>
<span class="lineno">  752 </span><span class="spaces">                </span><span class="nottickedoff">liftIO $ putStrLn $ &quot;    savilerow &quot; ++ unwords (map (quoteMultiWord . textToString) srArgs)</span>
<span class="lineno">  753 </span><span class="spaces">            </span><span class="nottickedoff">(stdoutSR, solutions) &lt;- partitionEithers &lt;$&gt; runHandle savilerowScriptName srArgs</span>
<span class="lineno">  754 </span><span class="spaces">                                        </span><span class="nottickedoff">(liftIO . srStdoutHandler</span>
<span class="lineno">  755 </span><span class="spaces">                                            </span><span class="nottickedoff">(outBase, modelPath, paramPath, ui)</span>
<span class="lineno">  756 </span><span class="spaces">                                            </span><span class="nottickedoff">tr (1::Int))</span>
<span class="lineno">  757 </span><span class="spaces">            </span><span class="nottickedoff">srCleanUp (stringToText $ unlines stdoutSR) solutions</span>
<span class="lineno">  758 </span><span class="spaces"></span><span class="nottickedoff">savileRowWithParams _ _ _ = bug &quot;savileRowWithParams&quot;</span></span>
<span class="lineno">  759 </span>
<span class="lineno">  760 </span>
<span class="lineno">  761 </span>srMkArgs :: UI -&gt; FilePath -&gt; FilePath -&gt; IO [Text]
<span class="lineno">  762 </span><span class="decl"><span class="istickedoff">srMkArgs Solve{..} outBase modelPath = do</span>
<span class="lineno">  763 </span><span class="spaces">    </span><span class="istickedoff">let genericOpts =</span>
<span class="lineno">  764 </span><span class="spaces">            </span><span class="istickedoff">[ &quot;-in-eprime&quot;      , stringToText $ outputDirectory &lt;/&gt; modelPath</span>
<span class="lineno">  765 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-out-minion&quot;     , stringToText $ outputDirectory &lt;/&gt; outBase ++ &quot;.eprime-minion&quot;</span>
<span class="lineno">  766 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-out-sat&quot;        , stringToText $ outputDirectory &lt;/&gt; outBase ++ &quot;.eprime-dimacs&quot;</span>
<span class="lineno">  767 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-out-aux&quot;        , stringToText $ outputDirectory &lt;/&gt; outBase ++ &quot;.eprime-aux&quot;</span>
<span class="lineno">  768 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-out-info&quot;       , stringToText $ outputDirectory &lt;/&gt; outBase ++ &quot;.eprime-info&quot;</span>
<span class="lineno">  769 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-out-minizinc&quot;   , stringToText $ outputDirectory &lt;/&gt; outBase ++ &quot;.eprime.mzn&quot;</span>
<span class="lineno">  770 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-run-solver&quot;</span>
<span class="lineno">  771 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-S0&quot;</span>
<span class="lineno">  772 </span><span class="spaces">            </span><span class="istickedoff">, &quot;-solutions-to-stdout-one-line&quot;</span>
<span class="lineno">  773 </span><span class="spaces">            </span><span class="istickedoff">] ++</span>
<span class="lineno">  774 </span><span class="spaces">            </span><span class="istickedoff">[ <span class="nottickedoff">&quot;-cgroups&quot;</span> | <span class="tickonlyfalse">cgroups</span> ] ++</span>
<span class="lineno">  775 </span><span class="spaces">            </span><span class="istickedoff">( if <span class="tickonlyfalse">nbSolutions == &quot;all&quot;</span></span>
<span class="lineno">  776 </span><span class="spaces">                </span><span class="istickedoff">then <span class="nottickedoff">[&quot;-all-solutions&quot;]</span></span>
<span class="lineno">  777 </span><span class="spaces">                </span><span class="istickedoff">else [&quot;-num-solutions&quot;, stringToText nbSolutions]</span>
<span class="lineno">  778 </span><span class="spaces">            </span><span class="istickedoff">)</span>
<span class="lineno">  779 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  780 </span><span class="spaces">    </span><span class="istickedoff">solverSelection &lt;- case solver of</span>
<span class="lineno">  781 </span><span class="spaces">        </span><span class="istickedoff">&quot;minion&quot;            -&gt; return [ &quot;-minion&quot; ]</span>
<span class="lineno">  782 </span><span class="spaces">        </span><span class="istickedoff">&quot;gecode&quot;            -&gt; <span class="nottickedoff">return [ &quot;-gecode&quot; ]</span></span>
<span class="lineno">  783 </span><span class="spaces">        </span><span class="istickedoff">&quot;chuffed&quot;           -&gt; <span class="nottickedoff">return [ &quot;-chuffed&quot;]</span></span>
<span class="lineno">  784 </span><span class="spaces">        </span><span class="istickedoff">&quot;glucose&quot;           -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  785 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;glucose&quot;</span></span>
<span class="lineno">  786 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;glucose&quot;</span></span>
<span class="lineno">  787 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  788 </span><span class="spaces">        </span><span class="istickedoff">&quot;glucose-syrup&quot;     -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  789 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;glucose&quot;</span></span>
<span class="lineno">  790 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;glucose-syrup&quot;</span></span>
<span class="lineno">  791 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  792 </span><span class="spaces">        </span><span class="istickedoff">&quot;cadical&quot;           -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  793 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;lingeling&quot;</span></span>
<span class="lineno">  794 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;cadical&quot;</span></span>
<span class="lineno">  795 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  796 </span><span class="spaces">        </span><span class="istickedoff">&quot;lingeling&quot;         -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  797 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;lingeling&quot;</span></span>
<span class="lineno">  798 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;lingeling&quot;</span></span>
<span class="lineno">  799 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  800 </span><span class="spaces">        </span><span class="istickedoff">&quot;plingeling&quot;        -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  801 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;lingeling&quot;</span></span>
<span class="lineno">  802 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;plingeling&quot;</span></span>
<span class="lineno">  803 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  804 </span><span class="spaces">        </span><span class="istickedoff">&quot;treengeling&quot;       -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  805 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;lingeling&quot;</span></span>
<span class="lineno">  806 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;treengeling&quot;</span></span>
<span class="lineno">  807 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  808 </span><span class="spaces">        </span><span class="istickedoff">&quot;minisat&quot;           -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  809 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;minisat&quot;</span></span>
<span class="lineno">  810 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;minisat&quot;</span></span>
<span class="lineno">  811 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  812 </span><span class="spaces">        </span><span class="istickedoff">&quot;bc_minisat_all&quot;    -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  813 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;bc_minisat_all&quot;</span></span>
<span class="lineno">  814 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;bc_minisat_all_release&quot;</span></span>
<span class="lineno">  815 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  816 </span><span class="spaces">        </span><span class="istickedoff">&quot;nbc_minisat_all&quot;   -&gt; <span class="nottickedoff">return [ &quot;-sat&quot;</span></span>
<span class="lineno">  817 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-sat-family&quot;, &quot;nbc_minisat_all&quot;</span></span>
<span class="lineno">  818 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;nbc_minisat_all_release&quot;</span></span>
<span class="lineno">  819 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  820 </span><span class="spaces">        </span><span class="istickedoff">&quot;open-wbo&quot;          -&gt; <span class="nottickedoff">return [ &quot;-maxsat&quot;</span></span>
<span class="lineno">  821 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-satsolver-bin&quot;, &quot;open-wbo&quot;</span></span>
<span class="lineno">  822 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  823 </span><span class="spaces">        </span><span class="istickedoff">&quot;coin-or&quot;           -&gt; <span class="nottickedoff">return [ &quot;-minizinc&quot;</span></span>
<span class="lineno">  824 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">, &quot;-solver-options&quot;, &quot;--solver COIN-BC&quot;</span></span>
<span class="lineno">  825 </span><span class="spaces">                                      </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  826 </span><span class="spaces">        </span><span class="istickedoff">&quot;cplex&quot;             -&gt; <span class="nottickedoff">do</span></span>
<span class="lineno">  827 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">env &lt;- getEnvironment</span></span>
<span class="lineno">  828 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">case lookup &quot;CPLEX_PATH&quot; env of</span></span>
<span class="lineno">  829 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">Nothing -&gt; userErr1 $ vcat</span></span>
<span class="lineno">  830 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">[ &quot;Set environment variable CPLEX_PATH. Something like:&quot;</span></span>
<span class="lineno">  831 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">, &quot;    CPLEX_PATH=/path/to/cplex/library conjure solve&quot;</span></span>
<span class="lineno">  832 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  833 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff">Just cplex_path -&gt;</span></span>
<span class="lineno">  834 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">return [ &quot;-minizinc&quot;</span></span>
<span class="lineno">  835 </span><span class="spaces">                           </span><span class="istickedoff"><span class="nottickedoff">, &quot;-solver-options&quot;, stringToText (&quot;--solver CPLEX --cplex-dll &quot; ++ cplex_path)</span></span>
<span class="lineno">  836 </span><span class="spaces">                           </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  837 </span><span class="spaces">        </span><span class="istickedoff">_ -&gt; <span class="nottickedoff">userErr1 (&quot;Unknown solver:&quot; &lt;+&gt; pretty solver)</span></span>
<span class="lineno">  838 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  839 </span><span class="spaces">    </span><span class="istickedoff">return $ genericOpts</span>
<span class="lineno">  840 </span><span class="spaces">          </span><span class="istickedoff">++ solverSelection</span>
<span class="lineno">  841 </span><span class="spaces">          </span><span class="istickedoff">++ map stringToText (concatMap words savilerowOptions)</span>
<span class="lineno">  842 </span><span class="spaces">          </span><span class="istickedoff">++ if <span class="tickonlyfalse">null solverOptions</span></span>
<span class="lineno">  843 </span><span class="spaces">                    </span><span class="istickedoff">then <span class="nottickedoff">[]</span></span>
<span class="lineno">  844 </span><span class="spaces">                    </span><span class="istickedoff">else [ &quot;-solver-options&quot;</span>
<span class="lineno">  845 </span><span class="spaces">                         </span><span class="istickedoff">, stringToText (unwords (concatMap words solverOptions))</span>
<span class="lineno">  846 </span><span class="spaces">                         </span><span class="istickedoff">]</span>
<span class="lineno">  847 </span><span class="spaces"></span><span class="istickedoff">srMkArgs _ _ _ = <span class="nottickedoff">bug &quot;srMkArgs&quot;</span></span></span>
<span class="lineno">  848 </span>
<span class="lineno">  849 </span>
<span class="lineno">  850 </span>srStdoutHandler ::
<span class="lineno">  851 </span>    (FilePath, FilePath, FilePath, UI) -&gt;
<span class="lineno">  852 </span>    (Model -&gt; NameGenM (IdentityT IO) Model) -&gt;
<span class="lineno">  853 </span>    Int -&gt;
<span class="lineno">  854 </span>    Handle -&gt;
<span class="lineno">  855 </span>    IO [Either String (FilePath, FilePath, Maybe FilePath)]
<span class="lineno">  856 </span><span class="decl"><span class="istickedoff">srStdoutHandler</span>
<span class="lineno">  857 </span><span class="spaces">        </span><span class="istickedoff">args@(outBase , modelPath, paramPath , Solve{..})</span>
<span class="lineno">  858 </span><span class="spaces">        </span><span class="istickedoff">tr solutionNumber h = do</span>
<span class="lineno">  859 </span><span class="spaces">    </span><span class="istickedoff">eof &lt;- hIsEOF h</span>
<span class="lineno">  860 </span><span class="spaces">    </span><span class="istickedoff">if eof</span>
<span class="lineno">  861 </span><span class="spaces">        </span><span class="istickedoff">then do</span>
<span class="lineno">  862 </span><span class="spaces">            </span><span class="istickedoff">hClose h</span>
<span class="lineno">  863 </span><span class="spaces">            </span><span class="istickedoff">return []</span>
<span class="lineno">  864 </span><span class="spaces">        </span><span class="istickedoff">else do</span>
<span class="lineno">  865 </span><span class="spaces">            </span><span class="istickedoff">line &lt;- hGetLine h</span>
<span class="lineno">  866 </span><span class="spaces">            </span><span class="istickedoff">case stripPrefix &quot;Solution: &quot; line of</span>
<span class="lineno">  867 </span><span class="spaces">                </span><span class="istickedoff">Nothing -&gt; do</span>
<span class="lineno">  868 </span><span class="spaces">                    </span><span class="istickedoff">if <span class="tickonlyfalse">isPrefixOf &quot;Created output file for domain filtering&quot; line</span></span>
<span class="lineno">  869 </span><span class="spaces">                        </span><span class="istickedoff">then <span class="nottickedoff">pp logLevel $ hsep [&quot;Running minion for domain filtering.&quot;]</span></span>
<span class="lineno">  870 </span><span class="spaces">                        </span><span class="istickedoff">else if isPrefixOf &quot;Created output&quot; line</span>
<span class="lineno">  871 </span><span class="spaces">                            </span><span class="istickedoff">then pp logLevel $ <span class="nottickedoff">hsep [&quot;Running solver:&quot;, pretty solver]</span></span>
<span class="lineno">  872 </span><span class="spaces">                            </span><span class="istickedoff">else return <span class="nottickedoff">()</span></span>
<span class="lineno">  873 </span><span class="spaces">                    </span><span class="istickedoff">fmap (Left line :)</span>
<span class="lineno">  874 </span><span class="spaces">                         </span><span class="istickedoff">(srStdoutHandler args tr solutionNumber h)</span>
<span class="lineno">  875 </span><span class="spaces">                </span><span class="istickedoff">Just solutionText -&gt; do</span>
<span class="lineno">  876 </span><span class="spaces">                    </span><span class="istickedoff">eprimeSol  &lt;- readModel ParserC.parseModel (Just id) (&quot;&lt;memory&gt;&quot;, stringToText solutionText)</span>
<span class="lineno">  877 </span><span class="spaces">                    </span><span class="istickedoff">essenceSol &lt;- ignoreLogs $ runNameGen <span class="nottickedoff">()</span> $ tr eprimeSol</span>
<span class="lineno">  878 </span><span class="spaces">                    </span><span class="istickedoff">case solutionsInOneFile of</span>
<span class="lineno">  879 </span><span class="spaces">                        </span><span class="istickedoff">False -&gt; do</span>
<span class="lineno">  880 </span><span class="spaces">                            </span><span class="istickedoff">let mkFilename ext = outputDirectory &lt;/&gt; outBase</span>
<span class="lineno">  881 </span><span class="spaces">                                                        </span><span class="istickedoff">++ &quot;-solution&quot; ++ padLeft 6 '0' (show solutionNumber)</span>
<span class="lineno">  882 </span><span class="spaces">                                                        </span><span class="istickedoff">++ ext</span>
<span class="lineno">  883 </span><span class="spaces">                            </span><span class="istickedoff">let filenameEprimeSol  = mkFilename &quot;.eprime-solution&quot;</span>
<span class="lineno">  884 </span><span class="spaces">                            </span><span class="istickedoff">let filenameEssenceSol = mkFilename &quot;.solution&quot;</span>
<span class="lineno">  885 </span><span class="spaces">                            </span><span class="istickedoff">writeModel lineWidth Plain (Just filenameEprimeSol) eprimeSol</span>
<span class="lineno">  886 </span><span class="spaces">                            </span><span class="istickedoff">writeModel lineWidth Plain (Just filenameEssenceSol) essenceSol</span>
<span class="lineno">  887 </span><span class="spaces">                            </span><span class="istickedoff">when (outputFormat == JSON) $</span>
<span class="lineno">  888 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">writeModel lineWidth JSON (Just (filenameEssenceSol ++ &quot;.json&quot;)) essenceSol</span></span>
<span class="lineno">  889 </span><span class="spaces">                            </span><span class="istickedoff">fmap (Right <span class="nottickedoff">(modelPath, paramPath, Just filenameEssenceSol)</span> :)</span>
<span class="lineno">  890 </span><span class="spaces">                                 </span><span class="istickedoff">(srStdoutHandler args tr (solutionNumber+1) h)</span>
<span class="lineno">  891 </span><span class="spaces">                        </span><span class="istickedoff">True -&gt; <span class="nottickedoff">do</span></span>
<span class="lineno">  892 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let mkFilename ext = outputDirectory &lt;/&gt; outBase</span></span>
<span class="lineno">  893 </span><span class="spaces">                                                        </span><span class="istickedoff"><span class="nottickedoff">++ ext</span></span>
<span class="lineno">  894 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let filenameEprimeSol  = mkFilename &quot;.eprime-solutions&quot;</span></span>
<span class="lineno">  895 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">let filenameEssenceSol = mkFilename &quot;.solutions&quot;</span></span>
<span class="lineno">  896 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">-- remove the solutions files before writing the first solution</span></span>
<span class="lineno">  897 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">when (solutionNumber == 1) $ do</span></span>
<span class="lineno">  898 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">removeFileIfExists filenameEprimeSol</span></span>
<span class="lineno">  899 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">removeFileIfExists filenameEssenceSol</span></span>
<span class="lineno">  900 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">appendFile filenameEprimeSol  (&quot;$ Solution: &quot; ++ padLeft 6 '0' (show solutionNumber))</span></span>
<span class="lineno">  901 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">appendFile filenameEprimeSol  (&quot;\n&quot; ++ render lineWidth eprimeSol  ++ &quot;\n\n&quot;)</span></span>
<span class="lineno">  902 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">appendFile filenameEssenceSol (&quot;$ Solution: &quot; ++ padLeft 6 '0' (show solutionNumber))</span></span>
<span class="lineno">  903 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">appendFile filenameEssenceSol (&quot;\n&quot; ++ render lineWidth essenceSol ++ &quot;\n\n&quot;)</span></span>
<span class="lineno">  904 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff">fmap (Right (modelPath, paramPath, Nothing) :)</span></span>
<span class="lineno">  905 </span><span class="spaces">                                 </span><span class="istickedoff"><span class="nottickedoff">(srStdoutHandler args tr (solutionNumber+1) h)</span></span>
<span class="lineno">  906 </span><span class="spaces"></span><span class="istickedoff">srStdoutHandler _ _ _ _ = <span class="nottickedoff">bug &quot;srStdoutHandler&quot;</span></span></span>
<span class="lineno">  907 </span>
<span class="lineno">  908 </span>
<span class="lineno">  909 </span>srCleanUp :: Text -&gt; sols -&gt; Sh (Either [Doc] sols)
<span class="lineno">  910 </span><span class="decl"><span class="istickedoff">srCleanUp stdoutSR solutions = do</span>
<span class="lineno">  911 </span><span class="spaces">    </span><span class="istickedoff">stderrSR   &lt;- lastStderr</span>
<span class="lineno">  912 </span><span class="spaces">    </span><span class="istickedoff">exitCodeSR &lt;- lastExitCode</span>
<span class="lineno">  913 </span><span class="spaces">    </span><span class="istickedoff">let combinedSR = T.unlines [stdoutSR, stderrSR]</span>
<span class="lineno">  914 </span><span class="spaces">    </span><span class="istickedoff">if  | <span class="tickonlyfalse">T.isInfixOf &quot;Savile Row timed out.&quot; combinedSR</span> -&gt;</span>
<span class="lineno">  915 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">return (Left [&quot;Savile Row timed out.&quot;])</span></span>
<span class="lineno">  916 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlyfalse">T.isInfixOf &quot;where false&quot; combinedSR</span> -&gt;</span>
<span class="lineno">  917 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">return (Left [vcat [ &quot;Invalid instance, a where statement evaluated to false.&quot;</span></span>
<span class="lineno">  918 </span><span class="spaces">                               </span><span class="istickedoff"><span class="nottickedoff">, &quot;(It can be an implicit where statement added by Conjure.)&quot;</span></span>
<span class="lineno">  919 </span><span class="spaces">                               </span><span class="istickedoff"><span class="nottickedoff">]])</span></span>
<span class="lineno">  920 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlyfalse">or [ T.isInfixOf &quot;Exception in thread&quot; combinedSR</span></span>
<span class="lineno">  921 </span><span class="spaces">             </span><span class="istickedoff"><span class="tickonlyfalse">, T.isInfixOf &quot;ERROR&quot; combinedSR</span></span>
<span class="lineno">  922 </span><span class="spaces">             </span><span class="istickedoff"><span class="tickonlyfalse">, T.isInfixOf &quot;Sub-process exited with error code&quot; combinedSR</span></span>
<span class="lineno">  923 </span><span class="spaces">             </span><span class="istickedoff"><span class="tickonlyfalse">]</span> -&gt;</span>
<span class="lineno">  924 </span><span class="spaces">             </span><span class="istickedoff"><span class="nottickedoff">return (Left [vcat [ &quot;Savile Row stdout:&quot;    &lt;+&gt; pretty stdoutSR</span></span>
<span class="lineno">  925 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">, &quot;Savile Row stderr:&quot;    &lt;+&gt; pretty stderrSR</span></span>
<span class="lineno">  926 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">, &quot;Savile Row exit-code:&quot; &lt;+&gt; pretty exitCodeSR</span></span>
<span class="lineno">  927 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff">]])</span></span>
<span class="lineno">  928 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlytrue">exitCodeSR == 0</span> -&gt; return (Right solutions)</span>
<span class="lineno">  929 </span><span class="spaces">        </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> -&gt;</span>
<span class="lineno">  930 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">return (Left [vcat [ &quot;Savile Row stdout:&quot;    &lt;+&gt; pretty stdoutSR</span></span>
<span class="lineno">  931 </span><span class="spaces">                               </span><span class="istickedoff"><span class="nottickedoff">, &quot;Savile Row stderr:&quot;    &lt;+&gt; pretty stderrSR</span></span>
<span class="lineno">  932 </span><span class="spaces">                               </span><span class="istickedoff"><span class="nottickedoff">, &quot;Savile Row exit-code:&quot; &lt;+&gt; pretty exitCodeSR</span></span>
<span class="lineno">  933 </span><span class="spaces">                               </span><span class="istickedoff"><span class="nottickedoff">]])</span></span></span>
<span class="lineno">  934 </span>
<span class="lineno">  935 </span>
<span class="lineno">  936 </span>validateSolutionNoParam ::
<span class="lineno">  937 </span>    (?typeCheckerMode :: TypeCheckerMode) =&gt;
<span class="lineno">  938 </span>    UI -&gt; FilePath -&gt; IO ()
<span class="lineno">  939 </span><span class="decl"><span class="nottickedoff">validateSolutionNoParam Solve{..} solutionPath = do</span>
<span class="lineno">  940 </span><span class="spaces">    </span><span class="nottickedoff">pp logLevel $ hsep [&quot;Validating solution:&quot;, pretty solutionPath]</span>
<span class="lineno">  941 </span><span class="spaces">    </span><span class="nottickedoff">essenceM &lt;- readModelFromFile essence</span>
<span class="lineno">  942 </span><span class="spaces">    </span><span class="nottickedoff">solution &lt;- readParamOrSolutionFromFile solutionPath</span>
<span class="lineno">  943 </span><span class="spaces">    </span><span class="nottickedoff">[essenceM2, solution2] &lt;- ignoreLogs $ runNameGen () $ resolveNamesMulti [essenceM, solution]</span>
<span class="lineno">  944 </span><span class="spaces">    </span><span class="nottickedoff">failToUserError $ ignoreLogs $ runNameGen () $ validateSolution essenceM2 def solution2</span>
<span class="lineno">  945 </span><span class="spaces"></span><span class="nottickedoff">validateSolutionNoParam _ _ = bug &quot;validateSolutionNoParam&quot;</span></span>
<span class="lineno">  946 </span>
<span class="lineno">  947 </span>
<span class="lineno">  948 </span>validateSolutionWithParams ::
<span class="lineno">  949 </span>    (?typeCheckerMode :: TypeCheckerMode) =&gt;
<span class="lineno">  950 </span>    UI -&gt; FilePath -&gt; FilePath -&gt; IO ()
<span class="lineno">  951 </span><span class="decl"><span class="nottickedoff">validateSolutionWithParams Solve{..} solutionPath paramPath = do</span>
<span class="lineno">  952 </span><span class="spaces">    </span><span class="nottickedoff">pp logLevel $ hsep [&quot;Validating solution:&quot;, pretty paramPath, pretty solutionPath]</span>
<span class="lineno">  953 </span><span class="spaces">    </span><span class="nottickedoff">essenceM &lt;- readModelFromFile essence</span>
<span class="lineno">  954 </span><span class="spaces">    </span><span class="nottickedoff">param    &lt;- readParamOrSolutionFromFile paramPath</span>
<span class="lineno">  955 </span><span class="spaces">    </span><span class="nottickedoff">solution &lt;- readParamOrSolutionFromFile solutionPath</span>
<span class="lineno">  956 </span><span class="spaces">    </span><span class="nottickedoff">[essenceM2, param2, solution2] &lt;- ignoreLogs $ runNameGen () $ resolveNamesMulti [essenceM, param, solution]</span>
<span class="lineno">  957 </span><span class="spaces">    </span><span class="nottickedoff">failToUserError $ ignoreLogs $ runNameGen () $ validateSolution essenceM2 param2 solution2</span>
<span class="lineno">  958 </span><span class="spaces"></span><span class="nottickedoff">validateSolutionWithParams _ _ _ = bug &quot;validateSolutionWithParams&quot;</span></span>
<span class="lineno">  959 </span>
<span class="lineno">  960 </span>
<span class="lineno">  961 </span>doIfNotCached
<span class="lineno">  962 </span>    :: (MonadIO m, Hashable h)
<span class="lineno">  963 </span>    =&gt; h                        -- thing to hash
<span class="lineno">  964 </span>    -&gt; FilePath                 -- saved hashes file
<span class="lineno">  965 </span>    -&gt; m a                      -- the result from cache
<span class="lineno">  966 </span>    -&gt; m a                      -- the action
<span class="lineno">  967 </span>    -&gt; m a                      -- the results and writing the new hashes in the file
<span class="lineno">  968 </span><span class="decl"><span class="istickedoff">doIfNotCached (show . hash -&gt; h) savedHashesFile getResult act = do</span>
<span class="lineno">  969 </span><span class="spaces">    </span><span class="istickedoff">savedHashes &lt;- liftIO $ readFileIfExists savedHashesFile</span>
<span class="lineno">  970 </span><span class="spaces">    </span><span class="istickedoff">let skip = Just <span class="nottickedoff">h</span> == savedHashes                -- skip if h was the hash in the file</span>
<span class="lineno">  971 </span><span class="spaces">    </span><span class="istickedoff">if <span class="tickonlyfalse">skip</span></span>
<span class="lineno">  972 </span><span class="spaces">        </span><span class="istickedoff">then <span class="nottickedoff">getResult</span></span>
<span class="lineno">  973 </span><span class="spaces">        </span><span class="istickedoff">else do</span>
<span class="lineno">  974 </span><span class="spaces">            </span><span class="istickedoff">res &lt;- act</span>
<span class="lineno">  975 </span><span class="spaces">            </span><span class="istickedoff">liftIO $ writeFile savedHashesFile h</span>
<span class="lineno">  976 </span><span class="spaces">            </span><span class="istickedoff">return res</span></span>
<span class="lineno">  977 </span>
<span class="lineno">  978 </span>
<span class="lineno">  979 </span>autoParallel :: [IO a] -&gt; IO [a]
<span class="lineno">  980 </span><span class="decl"><span class="istickedoff">autoParallel = if <span class="tickonlyfalse">numCapabilities &gt; 1</span> then <span class="nottickedoff">parallel</span> else sequence</span></span>
<span class="lineno">  981 </span>
<span class="lineno">  982 </span>
<span class="lineno">  983 </span>autoParallel_ :: [IO ()] -&gt; IO ()
<span class="lineno">  984 </span><span class="decl"><span class="nottickedoff">autoParallel_ = if numCapabilities &gt; 1 then parallel_ else sequence_</span></span>
<span class="lineno">  985 </span>

</pre>
</body>
</html>
